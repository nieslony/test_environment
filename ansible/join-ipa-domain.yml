- name: Join IPA domain
  hosts: all
  become: true

  vars_files:
    - "../config.yml"
    - ipa-vars.yml

  vars:
    ipa_client_packages_centos:
        - "@idm"
        - openldap-clients

    ipa_client_packages_fedora:
        - "@domain-client"
        - openldap-clients

  tasks:
    - name: Install Updates
      dnf:
        name: "*"
        state: latest

    - name: "Install Fedora Packages: {{ ipa_client_packages_fedora | join(', ') }}"
      dnf:
        name: "{{ ipa_client_packages_fedora }}"
      when: ansible_distribution == "Fedora"

    - name: "Install CentOS Packages: {{ ipa_client_packages_centos | join(', ') }}"
      dnf:
        name: "{{ ipa_client_packages_centos }}"
      when: ansible_distribution == "CentOS"

    - name: "Join {{ ipaserver_realm }}"
      command: >
        ipa-client-install
        --unattended
        --principal=admin
        --password={{ ipaadmin_password }}
        --force-join
        --configure-firefox
        --mkhomedir
        --ssh-trust-dns
        --enable-dns-updates
        --ntp-pool=pool.ntp.org
      args:
        creates: /etc/krb5.keytab

    - name: Configure sssd
      ini_file:
        path: /etc/sssd/sssd.conf
        section: nss
        option: "{{ item.key }}"
        value: "{{ item.value }}"
      loop: "{{ sssd_params | dict2items }}"
      vars:
        sssd_params:
            default_shell: "/bin/bash"
            case_sensitive: "False"
      notify:
        - Restart SSSD

  handlers:
    - name: Restart SSSD
      service:
        name: sssd
        state: restarted
