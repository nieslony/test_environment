- name: "Configure network"
  hosts: all
  become: true

  vars:
    network_names:
        "192.168.100.0": "Internet"
        "192.168.110.0": "Lab_Windows_Internal"
        "192.168.120.0": "Lab_Linux_Internal"
        "192.168.121.0": "Management"

    static_network: {}
#        "192.168.120.0": { ip: "192.168.120.250/24", dns: ["192.168.120.254"], gw: "192.168.120.254" }

  tasks:
    - block:
        - name: "Install NetworkManager"
          apt:
            name: network-manager
            update_cache: yes

        - name: "Manage all interfaces"
          copy:
            content: |
              [keyfile]
              unmanaged-devices=none
            dest: /etc/NetworkManager/conf.d/manage-all.conf

        - name: "Disable netplan"
          service:
            name: "{{ item }}"
            enabled: no
          with_items:
            - systemd-networkd.service
            - systemd-networkd.socket
            - networkd-dispatcher.service
      when: ansible_distribution == "Ubuntu"

    - name: "Add NetworkManager connections"
      vars:
        network: "{{ ansible_facts[item].ipv4.network }}"
        is_management: "{{ ansible_facts[item].ipv4.network == '192.168.121.0' }}"
        has_static_ip: "{{ ansible_facts[item].ipv4.network in static_network }}"
      nmcli:
        conn_name: >-
            {%- if ansible_facts[item].ipv4.network in network_names -%}
                {{ network_names[ansible_facts[item].ipv4.network] }}
            {%- else -%}
                Other
            {%- endif -%}
        ifname: "{{ item }}"
        type: ethernet
        state: present
        dns4_ignore_auto: "{{ is_management | ternary(true, omit) }}"
        never_default4: "{{ is_management | ternary(true, omit)}}"
        ip4: "{{ has_static_ip | ternary(static_network[network].ip, omit) }}"
        dns4: "{{ has_static_ip | ternary(static_network[network].dns, omit) }}"
        gw4: "{{ has_static_ip | ternary(static_network[network].gw, omit) }}"
        autoconnect: true
      when: ansible_facts[item].type == "ether"
      loop: "{{ ansible_facts.interfaces }}"

    - name: "Find NetworkManager connections"
      command: "nmcli --fields NAME,TYPE --terse con show"
      register: nmcli_con_show
      changed_when: no

    - name: "Remove NetworkManager connections"
      nmcli:
        conn_name: "{{ item.split(':')[0] }}"
        state: absent
      when:
        - item.split(":")[1] == "802-3-ethernet"
        - not item.split(":")[0] in network_names.values()
      loop: "{{ nmcli_con_show.stdout_lines }}"
      register: remove_connections

    - name: "Removing entries like 127.0.0.1 {{ ansible_hostname }} from /etc/hosts"
      lineinfile:
        path: /etc/hosts
        regex: "127.0.[0-9]*.1.*{{ ansible_hostname }}.*"
        state: absent

    - name: "Copy yum.conf -> dnf.conf"
      copy:
        src: "/etc/yum.conf"
        dest: "/etc/dnf/dnf.conf"
        remote_src: true
      when:
        - ansible_facts.os_family == "RedHat"
        - ("/etc/yum.conf" | realpath) != ("/etc/dnf/dnf.conf" | realpath)

    - block:
        - name: Restart NetworkManager
          service:
            name: NetworkManager
            state: restarted

        - name: "Reboot with NetworkManager + netplan"
          reboot:

        - name: "Remove current netplan config"
          file:
            path: "/etc/netplan/{{ item }}"
            state: absent
          with_items:
            - 50-cloud-init.yaml
            - 50-vagrant.yaml

        - gather_facts:

        - name: "Set new IP address {{ ansible_eth0.ipv4_secondaries[0].address }} for next connections"
          set_fact:
            ansible_host: "{{ ansible_eth0.ipv4_secondaries[0].address }}"

        - name: "Reboot with NetworkManager only"
          reboot:
      when: ansible_distribution == "Ubuntu"
